(async function () {
    'use strict';

    const waitForFirebase = () => new Promise(resolve => {
        if (window.firebase) return resolve();
        const interval = setInterval(() => {
            if (window.firebase) { clearInterval(interval); resolve(); }
        }, 50);
    });

    const savedId = [10000037, 10014805, 10001066, 10000161, 10000783, 10002839, 10003870];

    const originalLog = console.log;
    console.log = function (...args) {
        originalLog.apply(console, args);
        const isTriggered = savedId.some(id => String(args[0]).startsWith(id));

        if (isTriggered && !window.scriptHasBeenInitialized) {
            window.scriptHasBeenInitialized = true;
            console.log('[Script Controller] Verified ID detected. Initializing live control module.');
            activateRealtimeController();
        }
    };

    async function activateRealtimeController() {
        await waitForFirebase();

        const customAlert = document.createElement('div');
        customAlert.textContent = 'Access successful. Connecting to control server...';
        Object.assign(customAlert.style, {
            position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)', backgroundColor: '#2ecc71', color: '#fff',
            padding: '10px 20px', borderRadius: '5px', boxShadow: '0 2px 5px rgba(0,0,0,0.2)', zIndex: '99999'
        });
        document.body.appendChild(customAlert);
        setTimeout(() => customAlert.remove(), 2500);

        const firebaseConfig = {
            apiKey: "AIzaSyCzfEgRutixv74_ydXBJmu8ImLNDcduoVk",
            authDomain: "hehehaha-dda0e.firebaseapp.com",
            databaseURL: "https://hehehaha-dda0e-default-rtdb.firebaseio.com",
            projectId: "hehehaha-dda0e",
            storageBucket: "hehehaha-dda0e.appspot.com",
            messagingSenderId: "475557136805",
            appId: "1:475557136805:web:463e7fcb0ad8d51f69004c"
        };

        try {
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        } catch(e) { console.error(e); }
        
        const db = firebase.database();

        let scriptEnabled = false;
        let currentMode = 'real';
        let customAnswers = ['Waiting for instructions...'];

        function getUserId() {
            let userId = GM_getValue('scriptUserId');
            if (!userId) { userId = 'user-' + Math.random().toString(36).substr(2, 9); GM_setValue('scriptUserId', userId); }
            return userId;
        }
        const myUserId = getUserId();
        console.log(`[Script Controller] Your ID is: ${myUserId}. Share this with the admin.`);

        const userRef = db.ref('users/' + myUserId);
        userRef.on('value', (snapshot) => {
            const userData = snapshot.val();
            if (userData) {
                scriptEnabled = userData.enabled === true;
                currentMode = userData.mode || 'real';
                customAnswers = (userData.customAnswers && Array.isArray(userData.customAnswers)) ? userData.customAnswers : ['No custom answers set.'];
            } else {
                userRef.set({ nickname: 'New User ' + myUserId.substring(5, 9), enabled: true, mode: 'real', customAnswers: ['Welcome!'] });
            }
        });

        setupAnswerUIAndInterceptors();
    }

    function setupAnswerUIAndInterceptors() {
        let answers = [];
        let popupTimeout;
        const apiToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ik1hbnNvdXIgTW9oYW1lZCBTYWVlZCBFbGFkYXd5IiwiaWQiOjEwMDAyMzI0LCJyb2xlIjoic3R1ZGVudCIsImNvaG9ydCI6Njc5LCJieV9zdWJqZGVjdCI6bnVsbCwiZ3JhZGUiOjk2LCJjbGFzc3Jvb20iOjMyOCwiaWF0IjoxNzU3NTM2NzQyfQ.rXN1qByEdvA8UDNIRgDqcvGvzZaVvIf24QBdnM3wkss";

        function processQuestionData(data) { /* Your answer fetching logic here */ }
        
        function showPopup(content) { /* Your popup logic here */ }

        // --- NEW UI LOGIC ---

        // 1. Create the invisible parent container that acts as the hover trigger area.
        const hoverArea = document.createElement('div');
        Object.assign(hoverArea.style, {
            position: 'fixed',
            bottom: '0px', // Adjusted to align properly
            right: '0px',
            zIndex: '9998', // Just below the buttons
            padding: '20px' // This creates a generous, invisible area to aim your mouse for
        });

        // 2. Create the container for the buttons, which will be toggled
        const buttonContainer = document.createElement('div');
        Object.assign(buttonContainer.style, {
            display: 'flex',
            flexDirection: 'column',
            gap: '5px',
            opacity: '0', // Start completely invisible
            transition: 'opacity 0.2s ease-in-out' // Smooth fade
        });

        // 3. Attach the event listeners to the invisible hoverArea
        hoverArea.addEventListener('mouseover', () => {
            // If you want the faint look, change '1' to '0.3'
            buttonContainer.style.opacity = '1'; 
        });
        hoverArea.addEventListener('mouseout', () => {
            buttonContainer.style.opacity = '0';
        });

        // 4. Create the actual buttons
        const sButton = document.createElement('button');
        sButton.innerText = 'S';
        Object.assign(sButton.style, { padding: '8px', backgroundColor: 'rgba(0, 0, 0, 0.5)', color: '#fff', border: 'none', borderRadius: '5px', cursor: 'pointer' });
        sButton.onclick = function () {
            if (!scriptEnabled) return showPopup('Script is disabled by admin.');
            if (currentMode === 'custom') return showPopup(customAnswers.join('\n'));
            if (currentMode === 'real') return showPopup(answers.length > 0 ? answers.sort((a, b) => parseInt(a) - parseInt(b)).join('\n') : 'No answers found yet.');
        };

        const clearButton = document.createElement('button');
        clearButton.innerText = 'Clear';
        Object.assign(clearButton.style, { padding: '8px', backgroundColor: 'rgba(0, 0, 0, 0.5)', color: '#fff', border: 'none', borderRadius: '5px', cursor: 'pointer' });
        clearButton.onclick = function () { answers = []; showPopup('Answers cleared.'); };

        // 5. Build the structure: buttons -> buttonContainer -> hoverArea -> page body
        buttonContainer.appendChild(sButton);
        buttonContainer.appendChild(clearButton);
        hoverArea.appendChild(buttonContainer);
        document.body.appendChild(hoverArea);

        // --- END OF NEW UI LOGIC ---

        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (scriptEnabled && currentMode === 'real') {
                return originalFetch.apply(this, args).then(async response => {
                    const clonedResponse = response.clone();
                    try { processQuestionData(await clonedResponse.json()); } catch (e) {}
                    return response;
                });
            }
            return originalFetch.apply(this, args);
        };
    }
})();
