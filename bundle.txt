(async function () {
    'use strict';

    function getGeminiResponse(prompt) {
        const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + apiKey;

        const body = {
            contents: [{
                parts: [{
                    text: prompt
                }]
            }]
        };

        return fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const resultText = data.candidates[0].content.parts[0].text.trim();
            GM_setClipboard(resultText);
            showCheckmark();
            return resultText;
        })
        .catch(error => {
            console.error("Error fetching from Gemini:", error);
            return "Error: Could not retrieve response from Gemini.";
        });
    }

    function showCheckmark() {
        const checkmark = document.createElement('div');
        checkmark.innerText = 'âœ…';
        checkmark.style.position = 'fixed';
        checkmark.style.top = '45px';
        checkmark.style.right = '15px';
        checkmark.style.fontSize = '20px';
        checkmark.style.zIndex = '10002';
        checkmark.style.transition = 'opacity 0.5s ease';
        document.body.appendChild(checkmark);

        setTimeout(() => {
            checkmark.remove();
        }, 800);
    }

    function showPrompt() {
        const promptContainer = document.createElement('div');
        promptContainer.style.position = 'fixed';
        promptContainer.style.top = '50px';
        promptContainer.style.right = '10px';
        promptContainer.style.backgroundColor = '#333';
        promptContainer.style.padding = '10px';
        promptContainer.style.borderRadius = '8px';
        promptContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
        promptContainer.style.zIndex = '10001';

        const promptInput = document.createElement('input');
        promptInput.type = 'text';
        promptInput.placeholder = 'Type prompt here';
        promptInput.style.width = '100%';
        promptInput.style.padding = '8px';
        promptInput.style.borderRadius = '4px';
        promptInput.style.border = 'none';
        promptInput.style.fontSize = '14px';

        promptContainer.appendChild(promptInput);
        document.body.appendChild(promptContainer);

        promptInput.focus();

        function removePrompt() {
            promptContainer.remove();
            document.removeEventListener('click', onOutsideClick);
        }

        function onOutsideClick(event) {
            if (!promptContainer.contains(event.target) && event.target !== promptInput) {
                removePrompt();
            }
        }

        setTimeout(() => {
            document.addEventListener('click', onOutsideClick);
        }, 10);

        promptInput.addEventListener('keydown', async function (event) {
            if (event.key === 'Enter') {
                const promptText = promptInput.value;
                removePrompt();
                await getGeminiResponse(promptText);
            } else if (event.key === 'Escape') {
                removePrompt();
            }
        });
    }

    function createButton() {
        const button = document.createElement('button');
        button.innerText = 'AAAA';
        button.style.position = 'fixed';
        button.style.top = '10px';
        button.style.right = '10px';
        button.style.zIndex = '9999';
        button.style.padding = '8px';
        button.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        button.style.color = '#fff';
        button.style.border = 'none';
        button.style.borderRadius = '5px';
        button.style.cursor = 'pointer';
        button.style.opacity = '0';
        button.style.transition = 'opacity 0.3s ease';

        button.addEventListener('mouseover', () => {
            button.style.opacity = '0.5';
        });

        button.addEventListener('mouseout', () => {
            button.style.opacity = '0';
        });

        button.onclick = showPrompt;

        document.body.appendChild(button);
    }

    createButton();
})();
